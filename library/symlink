#!/usr/bin/env python
#
# Copyright 2013 Dale Sedivec
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.


DOCUMENTATION = '''
module: symlink
short_description: Make relative symbolic links
description:
  - This module exists solely because the standard M(file) module will
    not create a symbolic link with a relative target.  This module
    will only overwrite existing symbolic links; if C(path) exists but
    is not a symbolic link then this module will fail.
author: Dale Sedivec <dale@codefu.org>
options:
  src:
    description:
      - The path the symbolic link will refer to
    required: true
  path:
    description:
      - The path to the symbolic link
    required: true
  force:
    description:
      - "If true, the link will be created even if the src doesn't
        exist, or if the dest is a file that needs to be unlinked
        before being replaced with a symlink."
    choices:
      - "yes"
      - "no"
    default: "no"
'''

EXAMPLES = '''
- name: Use local PAM authentication files
  symlink: src={{ item }}-auth-local path=/etc/pam.d/{{ item }}-auth
  with_items:
    - system
    - password
'''


import os
import os.path
import stat


def main():
    module = AnsibleModule(
        argument_spec=dict(
            src=dict(required=True),
            path=dict(required=True),
            force=dict(default=False, type="bool"),
            ),
        supports_check_mode=True,
        )

    params = module.params
    src = params["src"]
    path = params["path"]
    force = params["force"]

    if not force:
        if os.path.isabs(src):
            abs_src = src
        else:
            abs_src = os.path.join(os.path.dirname(path), src)
        if not os.path.exists(abs_src):
            module.fail_json(msg="src=%r doesn't exist" % (abs_src,))
    if not os.path.isabs(path):
        module.fail_json(msg="path must be absolute")

    should_create_link = True
    try:
        path_stat = os.lstat(path)
    except OSError, ex:
        # ENOENT for "doesn't exist" is fine, other things are not.
        if ex.errno == errno.ENOENT:
            path_stat = None
        else:
            module.fail_json(msg="failure to stat %r: %s" % (path, ex))
    else:
        if stat.S_ISLNK(path_stat.st_mode):
            current_src = os.readlink(path)
            if current_src == src:
                should_create_link = False
        elif not force:
            msg = ("%r exists but is not a symlink, I will not clobber it" %
                   (path,))
            module.fail_json(msg=msg)

    if should_create_link and not module.check_mode:
        if path_stat:
            os.unlink(path)
        os.symlink(src, path)

    module.exit_json(changed=should_create_link)


# include magic from lib/ansible/module_common.py
#<<INCLUDE_ANSIBLE_MODULE_COMMON>>
main()
